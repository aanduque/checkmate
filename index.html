
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Check Mate - ADHD Task Manager</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'on-track': '#22c55e',
            'at-risk': '#eab308',
            'off-track': '#ef4444',
          }
        }
      }
    }
  </script>
  
  <!-- RRule for recurrence -->
  <script src="https://cdn.jsdelivr.net/npm/rrule@2.8.1/dist/es5/rrule.min.js"></script>

  <!-- Filtrex for safe expression evaluation -->
  <script src="https://cdn.jsdelivr.net/npm/filtrex@3/dist/filtrex.min.js"></script>
  
  <!-- Alpine Plugins -->
  <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/persist@3/dist/cdn.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/sort@3/dist/cdn.min.js"></script>

  <!-- Alpine.js -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js"></script>
  
  <style>
    [x-cloak] { display: none !important; }
    .task-card { transition: all 0.2s ease; }
    .task-card:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .health-pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    .modal-backdrop { background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
    .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    /* Drag and drop styles */
    .sortable-ghost { opacity: 0.4; background: #e0e7ff; }
    .sortable-drag { background: white; box-shadow: 0 10px 20px rgba(0,0,0,0.15); }
    .sortable-chosen { cursor: grabbing; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen" x-cloak x-data="checkMate()" x-init="init()">
  
  <div class="max-w-7xl mx-auto p-4">
    
    <!-- Header -->
    <header class="bg-white rounded-lg shadow-sm p-4 mb-6">
      <div class="flex items-center justify-between flex-wrap gap-4">
        <div class="flex items-center gap-3">
          <span class="text-3xl">‚ôüÔ∏è</span>
          <div>
            <h1 class="text-2xl font-bold text-gray-800">Check Mate</h1>
            <p class="text-sm text-gray-500">ADHD-Focused Task Management</p>
          </div>
        </div>
        
        <div class="flex items-center gap-4 flex-wrap">
          <!-- Active Routine Indicator -->
          <template x-if="activeRoutine">
            <div class="flex items-center gap-2 px-3 py-1 rounded-full text-sm font-medium"
                 :style="{ backgroundColor: activeRoutine.color + '20', color: activeRoutine.color }">
              <span x-text="activeRoutine.icon"></span>
              <span x-text="activeRoutine.name"></span>
              <button @click="clearRoutineOverride()" class="ml-1 opacity-60 hover:opacity-100" title="Clear override">‚úï</button>
            </div>
          </template>
          
          <!-- Manual Routine Selector -->
          <select x-model="manualRoutineId" class="text-sm border rounded-lg px-2 py-1">
            <option value="">Auto Routine</option>
            <template x-for="routine in routines" :key="routine.id">
              <option :value="routine.id" x-text="routine.icon + ' ' + routine.name"></option>
            </template>
          </select>
          
          <!-- Current Date -->
          <div class="text-sm text-gray-600" x-text="formatDate(today)"></div>
          
          <!-- Action Buttons -->
          <button @click="showTagsModal = true" class="p-2 hover:bg-gray-100 rounded-lg" title="Manage Tags">üè∑Ô∏è</button>
          <button @click="showRoutinesModal = true" class="p-2 hover:bg-gray-100 rounded-lg" title="Manage Routines">üîÑ</button>
          <button @click="showSettingsModal = true" class="p-2 hover:bg-gray-100 rounded-lg" title="Settings">‚öôÔ∏è</button>
        </div>
      </div>
    </header>
    
    <!-- Active Session Banner -->
    <template x-if="activeSession">
      <div class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg shadow-lg p-4 mb-6">
        <div class="flex items-center justify-between flex-wrap gap-4">
          <div class="flex items-center gap-4">
            <div class="text-4xl">üéØ</div>
            <div>
              <p class="text-sm opacity-80">Focusing on</p>
              <p class="font-bold text-lg" x-text="getTaskById(activeSession.taskId)?.title"></p>
            </div>
          </div>
          <div class="flex items-center gap-6">
            <div class="text-center">
              <p class="text-3xl font-mono font-bold" x-text="formatSessionTime(sessionElapsed)"></p>
              <p class="text-xs opacity-80">elapsed</p>
            </div>
            <div class="flex gap-2">
              <button @click="openCompleteSessionModal()" class="px-4 py-2 bg-green-500 hover:bg-green-600 rounded-lg font-medium">‚úì Complete</button>
              <button @click="abandonSession()" class="px-4 py-2 bg-red-500/20 hover:bg-red-500/30 rounded-lg">‚úï Abandon</button>
            </div>
          </div>
        </div>
      </div>
    </template>
    
    <!-- Main Navigation Tabs -->
    <div class="flex gap-2 mb-6 overflow-x-auto pb-2">
      <button @click="currentView = 'sprint'" 
              :class="currentView === 'sprint' ? 'bg-indigo-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-50'"
              class="px-4 py-2 rounded-lg font-medium whitespace-nowrap shadow-sm">
        üìÖ Sprints
      </button>
      <button @click="currentView = 'backlog'" 
              :class="currentView === 'backlog' ? 'bg-indigo-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-50'"
              class="px-4 py-2 rounded-lg font-medium whitespace-nowrap shadow-sm">
        üìã Backlog <span class="text-xs opacity-70" x-text="'(' + backlogTasks.length + ')'"></span>
      </button>
      <button @click="currentView = 'recurring'" 
              :class="currentView === 'recurring' ? 'bg-indigo-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-50'"
              class="px-4 py-2 rounded-lg font-medium whitespace-nowrap shadow-sm">
        üîÅ Recurring <span class="text-xs opacity-70" x-text="'(' + recurringTemplates.length + ')'"></span>
      </button>
      <button @click="currentView = 'completed'" 
              :class="currentView === 'completed' ? 'bg-indigo-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-50'"
              class="px-4 py-2 rounded-lg font-medium whitespace-nowrap shadow-sm">
        ‚úÖ Completed <span class="text-xs opacity-70" x-text="'(' + completedTasks.length + ')'"></span>
      </button>
    </div>
    
    <!-- Tag Filter Bar -->
    <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
      <div class="flex items-center gap-4 flex-wrap">
        <div class="flex items-center gap-2 flex-wrap">
          <span class="text-sm text-gray-500">Filter:</span>
          <button @click="toggleTagFilter(null)"
                  :class="selectedTagFilters.length === 0 ? 'bg-gray-800 text-white' : 'bg-gray-200 text-gray-700'"
                  class="px-2 py-1 rounded text-sm">All</button>
          <template x-for="tag in tags" :key="tag.id">
            <button @click="toggleTagFilter(tag.id)"
                    :class="selectedTagFilters.includes(tag.id) ? 'ring-2 ring-offset-1' : ''"
                    :style="{ backgroundColor: tag.color + '20', color: tag.color, '--tw-ring-color': tag.color }"
                    class="px-2 py-1 rounded text-sm flex items-center gap-1">
              <span x-text="tag.icon"></span>
              <span x-text="tag.name"></span>
            </button>
          </template>
        </div>
        <div class="flex-1"></div>
        <button @click="showCreateTaskModal = true" 
                class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium flex items-center gap-2">
          <span>+</span> New Task
        </button>
      </div>
    </div>
    
    <!-- ==================== SPRINT VIEW ==================== -->
    <div x-show="currentView === 'sprint'" class="space-y-6">
      <!-- Sprint Tabs -->
      <div class="flex gap-2 flex-wrap">
        <template x-for="(sprint, index) in sprints" :key="sprint.id">
          <button @click="selectedSprintIndex = index"
                  :class="selectedSprintIndex === index ? 'bg-white shadow-md ring-2 ring-indigo-500' : 'bg-gray-200/50 hover:bg-gray-200'"
                  class="px-4 py-2 rounded-lg font-medium flex items-center gap-2">
            <span x-text="getSprintLabel(index)"></span>
            <span class="text-xs px-2 py-0.5 rounded-full"
                  :class="{
                    'bg-on-track/20 text-on-track': getSprintHealth(sprint).overall === 'on_track',
                    'bg-at-risk/20 text-at-risk': getSprintHealth(sprint).overall === 'at_risk',
                    'bg-off-track/20 text-off-track': getSprintHealth(sprint).overall === 'off_track'
                  }"
                  x-text="getSprintHealth(sprint).overall.replace('_', ' ')"></span>
          </button>
        </template>
      </div>
      
      <!-- Sprint Content -->
      <template x-if="selectedSprint">
        <div class="bg-white rounded-lg shadow-sm p-6">
          <!-- Sprint Header -->
          <div class="flex items-start justify-between mb-6 flex-wrap gap-4">
            <div>
              <h2 class="text-xl font-bold text-gray-800" x-text="getSprintLabel(selectedSprintIndex)"></h2>
              <p class="text-sm text-gray-500">
                <span x-text="formatDate(selectedSprint.startDate)"></span> - 
                <span x-text="formatDate(selectedSprint.endDate)"></span>
                <span class="ml-2 font-medium">(<span x-text="getDaysRemaining(selectedSprint)"></span> days left)</span>
              </p>
            </div>
            <button @click="showSprintHealthModal = true" class="text-sm text-indigo-600 hover:underline">View health details</button>
          </div>
          
          <!-- Capacity Cards -->
          <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3 mb-6">
            <template x-for="tag in tags" :key="tag.id">
              <div class="bg-gray-50 rounded-lg p-3">
                <div class="flex items-center gap-2 mb-2">
                  <span x-text="tag.icon"></span>
                  <span class="text-sm font-medium truncate" x-text="tag.name"></span>
                </div>
                <div class="flex justify-between text-xs text-gray-600">
                  <span>Used:</span>
                  <span x-text="getSprintPointsForTag(selectedSprint, tag.id) + '/' + getCapacityForTag(selectedSprint, tag.id) + ' pts'"></span>
                </div>
                <div class="mt-2 h-2 bg-gray-200 rounded-full overflow-hidden">
                  <div class="h-full rounded-full transition-all"
                       :class="{
                         'bg-on-track': getSprintPointsForTag(selectedSprint, tag.id) / getCapacityForTag(selectedSprint, tag.id) <= 0.8,
                         'bg-at-risk': getSprintPointsForTag(selectedSprint, tag.id) / getCapacityForTag(selectedSprint, tag.id) > 0.8 && getSprintPointsForTag(selectedSprint, tag.id) / getCapacityForTag(selectedSprint, tag.id) <= 1,
                         'bg-off-track': getSprintPointsForTag(selectedSprint, tag.id) / getCapacityForTag(selectedSprint, tag.id) > 1
                       }"
                       :style="{ width: Math.min(100, (getSprintPointsForTag(selectedSprint, tag.id) / getCapacityForTag(selectedSprint, tag.id)) * 100) + '%' }"></div>
                </div>
                <button @click="editSprintCapacity(selectedSprint, tag)" class="text-xs text-indigo-600 hover:underline mt-1">Edit</button>
              </div>
            </template>
          </div>
          
          <!-- Sprint Tasks -->
          <div class="space-y-3" x-sort="handleTaskReorder">
            <template x-for="task in getSprintTasks(selectedSprint)" :key="task.id">
              <div x-sort:item="task.id"
                   class="task-card bg-gray-50 rounded-lg p-4 border-l-4 cursor-grab active:cursor-grabbing"
                   :class="{
                     'opacity-60': task.skipState?.type === 'for_day' && !task.skipState?.returned,
                     'border-l-yellow-400 bg-yellow-50/50': task.skipState?.type === 'for_now',
                     'border-l-blue-500 bg-blue-50/50': task.skipState?.type === 'for_day' && task.skipState?.returned
                   }"
                   :style="!task.skipState ? { borderLeftColor: getTaskPrimaryTag(task)?.color || '#ccc' } : {}">
                <div class="flex items-start justify-between gap-4">
                  <div class="flex items-center gap-2 text-gray-400 cursor-grab" x-sort:handle>‚†ø</div>
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 mb-1 flex-wrap">
                      <h3 class="font-medium text-gray-800" x-text="task.title"></h3>
                      <template x-if="task.parentId">
                        <span class="text-xs bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded">üîÅ instance</span>
                      </template>
                      <template x-if="task.skipState?.type === 'for_now'">
                        <span class="text-xs bg-yellow-100 text-yellow-700 px-1.5 py-0.5 rounded">‚è≠Ô∏è Skipped</span>
                      </template>
                      <template x-if="task.skipState?.type === 'for_day' && task.skipState?.returned">
                        <span class="text-xs bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded">üîô Returned!</span>
                      </template>
                    </div>
                    <div class="flex flex-wrap gap-1.5 mb-2">
                      <template x-for="(points, tagId) in task.tagPoints" :key="tagId">
                        <span class="text-xs px-2 py-0.5 rounded-full"
                              :style="{ backgroundColor: getTagById(tagId)?.color + '20', color: getTagById(tagId)?.color }">
                          <span x-text="getTagById(tagId)?.icon"></span>
                          <span x-text="getTagById(tagId)?.name"></span>
                          <span class="font-bold" x-text="points + 'pt'"></span>
                        </span>
                      </template>
                    </div>
                    <div class="flex items-center gap-3 text-xs text-gray-500">
                      <span x-text="getTaskAge(task) + 'd old'"></span>
                      <span x-text="(task.sessions?.length || 0) + ' sessions'"></span>
                      <span x-text="(task.comments?.length || 0) + ' comments'"></span>
                    </div>
                  </div>
                  <div class="flex items-center gap-1">
                    <button @click="startSession(task)" :disabled="activeSession" 
                            class="p-2 hover:bg-white rounded-lg text-green-600 disabled:opacity-40" title="Start Session">‚ñ∂Ô∏è</button>
                    <button @click="openTaskDetail(task)" class="p-2 hover:bg-white rounded-lg" title="Details">üìù</button>
                    <div class="relative" x-data="{ open: false }">
                      <button @click="open = !open" class="p-2 hover:bg-white rounded-lg">‚ãÆ</button>
                      <div x-show="open" @click.away="open = false" x-transition
                           class="absolute right-0 mt-1 w-48 bg-white rounded-lg shadow-lg border z-20 py-1">
                        <template x-if="task.skipState">
                          <button @click="clearSkipState(task); open = false" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm">‚Ü©Ô∏è Clear skip</button>
                        </template>
                        <button @click="skipTaskForNow(task); open = false" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm">‚è≠Ô∏è Skip for now</button>
                        <button @click="openSkipForDayModal(task); open = false" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm">üìÖ Skip for day</button>
                        <button @click="completeTask(task); open = false" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm text-green-600">‚úÖ Complete</button>
                        <button @click="moveTaskToBacklog(task); open = false" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm">üìã To Backlog</button>
                        <button @click="cancelTask(task); open = false" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm text-red-600">üóëÔ∏è Cancel</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </template>
            <template x-if="getSprintTasks(selectedSprint).length === 0">
              <div class="text-center py-12 text-gray-500">
                <p class="text-4xl mb-2">üì≠</p>
                <p>No tasks in this sprint</p>
                <p class="text-sm">Move tasks from the backlog or create new ones</p>
              </div>
            </template>
          </div>
        </div>
      </template>
    </div>
    
    <!-- ==================== BACKLOG VIEW ==================== -->
    <div x-show="currentView === 'backlog'" class="bg-white rounded-lg shadow-sm p-6">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-bold text-gray-800">Backlog</h2>
        <span class="text-sm text-gray-500" x-text="filteredBacklogTasks.length + ' tasks'"></span>
      </div>
      <div class="space-y-3">
        <template x-for="task in filteredBacklogTasks" :key="task.id">
          <div class="task-card bg-gray-50 rounded-lg p-4 border-l-4"
               :style="{ borderLeftColor: getTaskPrimaryTag(task)?.color || '#ccc' }">
            <div class="flex items-start justify-between gap-4">
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 mb-1 flex-wrap">
                  <h3 class="font-medium text-gray-800" x-text="task.title"></h3>
                  <template x-if="task.parentId">
                    <span class="text-xs bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded">üîÅ instance</span>
                  </template>
                </div>
                <template x-if="task.description">
                  <p class="text-sm text-gray-600 mb-2 line-clamp-2" x-text="task.description"></p>
                </template>
                <div class="flex flex-wrap gap-1.5 mb-2">
                  <template x-for="(points, tagId) in task.tagPoints" :key="tagId">
                    <span class="text-xs px-2 py-0.5 rounded-full"
                          :style="{ backgroundColor: getTagById(tagId)?.color + '20', color: getTagById(tagId)?.color }">
                      <span x-text="getTagById(tagId)?.icon"></span>
                      <span x-text="getTagById(tagId)?.name"></span>
                      <span class="font-bold" x-text="points + 'pt'"></span>
                    </span>
                  </template>
                </div>
                <div class="flex items-center gap-3 text-xs text-gray-500">
                  <span x-text="getTaskAge(task) + 'd old'"></span>
                  <span x-text="'In ' + (task.sprintHistory?.length || 0) + ' sprints'"></span>
                </div>
              </div>
              <div class="flex items-center gap-1">
                <div class="relative" x-data="{ open: false }">
                  <button @click="open = !open" class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-lg text-sm hover:bg-indigo-200">
                    Move ‚ñº
                  </button>
                  <div x-show="open" @click.away="open = false" x-transition
                       class="absolute right-0 mt-1 w-48 bg-white rounded-lg shadow-lg border z-20 py-1">
                    <template x-for="(sprint, index) in sprints" :key="sprint.id">
                      <button @click="moveTaskToSprint(task, sprint); open = false" 
                              class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm"
                              x-text="getSprintLabel(index)"></button>
                    </template>
                  </div>
                </div>
                <button @click="openTaskDetail(task)" class="p-2 hover:bg-gray-100 rounded-lg" title="Details">üìù</button>
                <button @click="cancelTask(task)" class="p-2 hover:bg-gray-100 rounded-lg text-red-500" title="Cancel">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        </template>
        <template x-if="filteredBacklogTasks.length === 0">
          <div class="text-center py-12 text-gray-500">
            <p class="text-4xl mb-2">üéâ</p>
            <p>Backlog is empty!</p>
            <p class="text-sm">Create new tasks or check your filters</p>
          </div>
        </template>
      </div>
    </div>
    
    <!-- ==================== RECURRING VIEW ==================== -->
    <div x-show="currentView === 'recurring'" class="bg-white rounded-lg shadow-sm p-6">
      <div class="flex items-center justify-between mb-6 flex-wrap gap-4">
        <div>
          <h2 class="text-xl font-bold text-gray-800">Recurring Templates</h2>
          <p class="text-sm text-gray-500">Templates spawn task instances based on their schedule</p>
        </div>
        <button @click="showCreateRecurringModal = true" 
                class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium">
          + New Recurring
        </button>
      </div>
      <div class="space-y-3">
        <template x-for="template in recurringTemplates" :key="template.id">
          <div class="task-card bg-gray-50 rounded-lg p-4 border-l-4 border-l-purple-400">
            <div class="flex items-start justify-between gap-4">
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 mb-1">
                  <span class="text-lg">üîÅ</span>
                  <h3 class="font-medium text-gray-800" x-text="template.title"></h3>
                </div>
                <p class="text-sm text-purple-600 mb-2" x-text="describeRRule(template.recurrence)"></p>
                <div class="flex flex-wrap gap-1.5 mb-2">
                  <template x-for="(points, tagId) in template.tagPoints" :key="tagId">
                    <span class="text-xs px-2 py-0.5 rounded-full"
                          :style="{ backgroundColor: getTagById(tagId)?.color + '20', color: getTagById(tagId)?.color }">
                      <span x-text="getTagById(tagId)?.icon"></span>
                      <span x-text="getTagById(tagId)?.name"></span>
                      <span class="font-bold" x-text="points + 'pt'"></span>
                    </span>
                  </template>
                </div>
                <div class="text-xs text-gray-500">
                  Next: <span x-text="formatDate(getNextOccurrence(template))"></span>
                </div>
              </div>
              <div class="flex items-center gap-1">
                <button @click="spawnRecurringInstance(template)" 
                        class="px-3 py-1 bg-purple-100 text-purple-700 rounded-lg text-sm hover:bg-purple-200">
                  Spawn Now
                </button>
                <button @click="openTaskDetail(template)" class="p-2 hover:bg-gray-100 rounded-lg">üìù</button>
                <button @click="cancelTask(template)" class="p-2 hover:bg-gray-100 rounded-lg text-red-500">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        </template>
        <template x-if="recurringTemplates.length === 0">
          <div class="text-center py-12 text-gray-500">
            <p class="text-4xl mb-2">üîÅ</p>
            <p>No recurring templates</p>
            <p class="text-sm">Create recurring tasks for regular activities</p>
          </div>
        </template>
      </div>
    </div>
    
    <!-- ==================== COMPLETED VIEW ==================== -->
    <div x-show="currentView === 'completed'" class="bg-white rounded-lg shadow-sm p-6">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-bold text-gray-800">Completed & Canceled</h2>
        <span class="text-sm text-gray-500" x-text="completedTasks.length + ' tasks'"></span>
      </div>
      <div class="space-y-3">
        <template x-for="task in completedTasks" :key="task.id">
          <div class="task-card bg-gray-50 rounded-lg p-4 border-l-4"
               :class="task.status === 'completed' ? 'border-l-green-400' : 'border-l-red-400'">
            <div class="flex items-start justify-between gap-4">
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 mb-1">
                  <span x-text="task.status === 'completed' ? '‚úÖ' : '‚ùå'"></span>
                  <h3 class="font-medium text-gray-500 line-through" x-text="task.title"></h3>
                </div>
                <div class="flex flex-wrap gap-1.5">
                  <template x-for="(points, tagId) in task.tagPoints" :key="tagId">
                    <span class="text-xs px-2 py-0.5 rounded-full opacity-60"
                          :style="{ backgroundColor: getTagById(tagId)?.color + '20', color: getTagById(tagId)?.color }">
                      <span x-text="getTagById(tagId)?.icon"></span>
                      <span class="font-bold" x-text="points + 'pt'"></span>
                    </span>
                  </template>
                </div>
              </div>
              <button @click="openTaskDetail(task)" class="p-2 hover:bg-gray-100 rounded-lg">üìù</button>
            </div>
          </div>
        </template>
        <template x-if="completedTasks.length === 0">
          <div class="text-center py-12 text-gray-500">
            <p class="text-4xl mb-2">üì≠</p>
            <p>No completed tasks yet</p>
          </div>
        </template>
      </div>
    </div>
    
  </div>
  
  <!-- ==================== MODALS ==================== -->
  
  <!-- Create Task Modal -->
  <div x-show="showCreateTaskModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" x-transition>
    <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto" @click.away="showCreateTaskModal = false">
      <div class="p-6">
        <h2 class="text-xl font-bold mb-4">Create New Task</h2>
        <form @submit.prevent="createTask()">
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Title *</label>
              <input type="text" x-model="newTask.title" required class="w-full border rounded-lg px-3 py-2" placeholder="What needs to be done?">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
              <textarea x-model="newTask.description" rows="3" class="w-full border rounded-lg px-3 py-2" placeholder="Additional details"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Points per Tag *</label>
              <div class="space-y-2">
                <template x-for="tag in tags" :key="tag.id">
                  <div class="flex items-center gap-3">
                    <div class="flex items-center gap-2 w-32" :style="{ color: tag.color }">
                      <span x-text="tag.icon"></span>
                      <span x-text="tag.name"></span>
                    </div>
                    <select x-model="newTask.tagPoints[tag.id]" class="border rounded-lg px-3 py-1">
                      <option value="">-</option>
                      <template x-for="pt in FIBONACCI_POINTS" :key="pt">
                        <option :value="pt" x-text="pt + ' pt'"></option>
                      </template>
                    </select>
                  </div>
                </template>
              </div>
              <p class="text-xs text-gray-500 mt-1">Select at least one tag with points</p>
            </div>
          </div>
          <div class="flex justify-end gap-3 mt-6">
            <button type="button" @click="showCreateTaskModal = false" class="px-4 py-2 border rounded-lg hover:bg-gray-50">Cancel</button>
            <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Create Task</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <!-- Create Recurring Task Modal -->
  <div x-show="showCreateRecurringModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" x-transition>
    <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto" @click.away="showCreateRecurringModal = false">
      <div class="p-6">
        <h2 class="text-xl font-bold mb-4">Create Recurring Task</h2>
        <form @submit.prevent="createRecurringTask()">
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Title *</label>
              <input type="text" x-model="newRecurring.title" required class="w-full border rounded-lg px-3 py-2" placeholder="Recurring task name">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
              <textarea x-model="newRecurring.description" rows="2" class="w-full border rounded-lg px-3 py-2" placeholder="Additional details"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Recurrence Pattern</label>
              <select x-model="newRecurring.recurrencePreset" class="w-full border rounded-lg px-3 py-2">
                <option value="FREQ=DAILY">Daily</option>
                <option value="FREQ=WEEKLY;BYDAY=MO,TU,WE,TH,FR">Weekdays</option>
                <option value="FREQ=WEEKLY">Weekly</option>
                <option value="FREQ=WEEKLY;BYDAY=MO,WE,FR">Mon, Wed, Fri</option>
                <option value="FREQ=WEEKLY;BYDAY=TU,TH">Tue, Thu</option>
                <option value="FREQ=MONTHLY">Monthly</option>
                <option value="custom">Custom RRULE...</option>
              </select>
              <template x-if="newRecurring.recurrencePreset === 'custom'">
                <input type="text" x-model="newRecurring.customRRule" class="w-full border rounded-lg px-3 py-2 mt-2" placeholder="FREQ=WEEKLY;BYDAY=MO,WE,FR">
              </template>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Points per Tag *</label>
              <div class="space-y-2">
                <template x-for="tag in tags" :key="tag.id">
                  <div class="flex items-center gap-3">
                    <div class="flex items-center gap-2 w-32" :style="{ color: tag.color }">
                      <span x-text="tag.icon"></span>
                      <span x-text="tag.name"></span>
                    </div>
                    <select x-model="newRecurring.tagPoints[tag.id]" class="border rounded-lg px-3 py-1">
                      <option value="">-</option>
                      <template x-for="pt in FIBONACCI_POINTS" :key="pt">
                        <option :value="pt" x-text="pt + ' pt'"></option>
                      </template>
                    </select>
                  </div>
                </template>
              </div>
            </div>
          </div>
          <div class="flex justify-end gap-3 mt-6">
            <button type="button" @click="showCreateRecurringModal = false" class="px-4 py-2 border rounded-lg hover:bg-gray-50">Cancel</button>
            <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Create</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <!-- Task Detail Modal -->
  <div x-show="showTaskDetailModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" x-transition>
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto" @click.away="showTaskDetailModal = false; saveTaskDetail()">
      <template x-if="selectedTask">
        <div class="p-6">
          <div class="flex items-start justify-between mb-4">
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-1">
                <span x-show="selectedTask.status === 'completed'" class="text-green-500">‚úÖ</span>
                <span x-show="selectedTask.status === 'canceled'" class="text-red-500">‚ùå</span>
                <span x-show="selectedTask.recurrence" class="text-purple-500">üîÅ</span>
                <input type="text" x-model="selectedTask.title" @change="saveTaskDetail()"
                       class="text-xl font-bold bg-transparent border-b border-transparent hover:border-gray-300 focus:border-indigo-500 outline-none w-full"
                       :disabled="selectedTask.status !== 'active'">
              </div>
              <div class="flex items-center gap-2 text-sm text-gray-500">
                <span x-text="'Created ' + formatDate(new Date(selectedTask.createdAt))"></span>
                <span>‚Ä¢</span>
                <span x-text="getTaskAge(selectedTask) + ' days old'"></span>
              </div>
            </div>
            <button @click="showTaskDetailModal = false; saveTaskDetail()" class="p-2 hover:bg-gray-100 rounded-lg">‚úï</button>
          </div>
          
          <!-- Description -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
            <textarea x-model="selectedTask.description" @change="saveTaskDetail()" rows="3"
                      class="w-full border rounded-lg px-3 py-2" placeholder="Add description..."
                      :disabled="selectedTask.status !== 'active'"></textarea>
          </div>
          
          <!-- Tags & Points -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Tags & Points</label>
            <div class="flex flex-wrap gap-2">
              <template x-for="(points, tagId) in selectedTask.tagPoints" :key="tagId">
                <div class="flex items-center gap-1 px-3 py-1 rounded-full"
                     :style="{ backgroundColor: getTagById(tagId)?.color + '20', color: getTagById(tagId)?.color }">
                  <span x-text="getTagById(tagId)?.icon"></span>
                  <span x-text="getTagById(tagId)?.name"></span>
                  <select x-model="selectedTask.tagPoints[tagId]" @change="saveTaskDetail()"
                          class="bg-transparent border-none text-sm font-bold w-16"
                          :disabled="selectedTask.status !== 'active'">
                    <template x-for="pt in FIBONACCI_POINTS" :key="pt">
                      <option :value="pt" x-text="pt + 'pt'"></option>
                    </template>
                  </select>
                </div>
              </template>
            </div>
          </div>
          
          <!-- Recurrence Info -->
          <template x-if="selectedTask.recurrence">
            <div class="mb-6 p-4 bg-purple-50 rounded-lg">
              <label class="block text-sm font-medium text-purple-700 mb-1">üîÅ Recurrence Pattern</label>
              <p class="text-purple-600" x-text="describeRRule(selectedTask.recurrence)"></p>
              <p class="text-xs text-purple-500 mt-1">Next: <span x-text="formatDate(getNextOccurrence(selectedTask))"></span></p>
            </div>
          </template>
          
          <!-- Sessions -->
          <div class="mb-6">
            <div class="flex items-center justify-between mb-2">
              <label class="block text-sm font-medium text-gray-700">Focus Sessions</label>
              <button @click="startSession(selectedTask); showTaskDetailModal = false"
                      :disabled="activeSession || selectedTask.status !== 'active'"
                      class="text-sm text-indigo-600 hover:underline disabled:opacity-50">+ Start Session</button>
            </div>
            <div class="space-y-2 max-h-40 overflow-y-auto">
              <template x-for="session in (selectedTask.sessions || []).slice().reverse()" :key="session.id">
                <div class="bg-gray-50 rounded-lg p-3 text-sm">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                      <span :class="{'text-green-500': session.status === 'completed', 'text-red-500': session.status === 'abandoned', 'text-blue-500': session.status === 'in_progress'}"
                            x-text="session.status === 'completed' ? '‚úì' : session.status === 'abandoned' ? '‚úï' : '‚ñ∂'"></span>
                      <span x-text="formatDate(new Date(session.startedAt))"></span>
                      <template x-if="session.endedAt">
                        <span class="text-gray-400" x-text="'(' + formatSessionTime(Math.floor((new Date(session.endedAt) - new Date(session.startedAt)) / 1000)) + ')'"></span>
                      </template>
                    </div>
                    <template x-if="session.focusLevel">
                      <span class="px-2 py-0.5 rounded text-xs"
                            :class="{'bg-green-100 text-green-700': session.focusLevel === 'focused', 'bg-yellow-100 text-yellow-700': session.focusLevel === 'neutral', 'bg-red-100 text-red-700': session.focusLevel === 'distracted'}"
                            x-text="session.focusLevel"></span>
                    </template>
                  </div>
                </div>
              </template>
              <template x-if="!selectedTask.sessions?.length">
                <p class="text-sm text-gray-500 italic">No sessions yet</p>
              </template>
            </div>
          </div>
          
          <!-- Comments -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Comments</label>
            <div class="space-y-2 mb-3 max-h-48 overflow-y-auto">
              <template x-for="comment in (selectedTask.comments || [])" :key="comment.id">
                <div class="bg-gray-50 rounded-lg p-3" :class="comment.skipJustification ? 'border-l-4 border-l-yellow-400' : ''">
                  <div class="flex items-start justify-between">
                    <div class="flex-1">
                      <template x-if="comment.skipJustification">
                        <span class="text-xs bg-yellow-100 text-yellow-700 px-1 rounded mb-1 inline-block">Skip Justification</span>
                      </template>
                      <p class="text-sm text-gray-700 whitespace-pre-wrap" x-text="comment.content"></p>
                      <p class="text-xs text-gray-400 mt-1" x-text="formatDate(new Date(comment.createdAt))"></p>
                    </div>
                    <button @click="deleteComment(selectedTask, comment)" class="text-red-400 hover:text-red-600 text-sm">üóëÔ∏è</button>
                  </div>
                </div>
              </template>
            </div>
            <div class="flex gap-2">
              <input type="text" x-model="newCommentContent" @keyup.enter="addComment(selectedTask)"
                     class="flex-1 border rounded-lg px-3 py-2 text-sm" placeholder="Add a comment...">
              <button @click="addComment(selectedTask)" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm">Add</button>
            </div>
          </div>
          
          <!-- Location & Parent -->
          <div class="text-sm text-gray-600">
            <p>Location: <span class="font-medium" x-text="selectedTask.location.type === 'backlog' ? 'üìã Backlog' : 'üìÖ Sprint'"></span></p>
            <template x-if="selectedTask.parentId">
              <p class="mt-1">
                üîÅ Instance of:
                <span class="font-medium" x-text="getTaskById(selectedTask.parentId)?.title"></span>
              </p>
            </template>
          </div>
        </div>
      </template>
    </div>
  </div>
  
  <!-- Skip For Day Modal -->
  <div x-show="showSkipForDayModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" x-transition>
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4" @click.away="showSkipForDayModal = false">
      <div class="p-6">
        <h2 class="text-xl font-bold mb-4">Skip for Day</h2>
        <p class="text-gray-600 mb-4">This task will be hidden until tomorrow. Please provide a justification.</p>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">Justification *</label>
          <textarea x-model="skipJustification" required rows="3" class="w-full border rounded-lg px-3 py-2" placeholder="Why are you skipping this task?"></textarea>
        </div>
        <div class="flex justify-end gap-3">
          <button @click="showSkipForDayModal = false" class="px-4 py-2 border rounded-lg hover:bg-gray-50">Cancel</button>
          <button @click="confirmSkipForDay()" :disabled="!skipJustification.trim()" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 disabled:opacity-50">Skip Task</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Complete Session Modal -->
  <div x-show="showCompleteSessionModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" x-transition>
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4" @click.away="showCompleteSessionModal = false">
      <div class="p-6">
        <h2 class="text-xl font-bold mb-4">Complete Session</h2>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">How focused were you?</label>
          <div class="flex gap-2">
            <button @click="sessionFocusLevel = 'distracted'" :class="sessionFocusLevel === 'distracted' ? 'ring-2 ring-red-500' : ''"
                    class="flex-1 p-3 rounded-lg bg-red-50 text-red-700 hover:bg-red-100">üòµ Distracted</button>
            <button @click="sessionFocusLevel = 'neutral'" :class="sessionFocusLevel === 'neutral' ? 'ring-2 ring-yellow-500' : ''"
                    class="flex-1 p-3 rounded-lg bg-yellow-50 text-yellow-700 hover:bg-yellow-100">üòê Neutral</button>
            <button @click="sessionFocusLevel = 'focused'" :class="sessionFocusLevel === 'focused' ? 'ring-2 ring-green-500' : ''"
                    class="flex-1 p-3 rounded-lg bg-green-50 text-green-700 hover:bg-green-100">üéØ Focused</button>
          </div>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">Session Note (optional)</label>
          <textarea x-model="sessionNote" rows="2" class="w-full border rounded-lg px-3 py-2" placeholder="What did you accomplish?"></textarea>
        </div>
        <div class="mb-4">
          <label class="flex items-center gap-2">
            <input type="checkbox" x-model="markTaskComplete" class="rounded">
            <span class="text-sm text-gray-700">Also mark task as complete</span>
          </label>
        </div>
        <div class="flex justify-end gap-3">
          <button @click="showCompleteSessionModal = false" class="px-4 py-2 border rounded-lg hover:bg-gray-50">Cancel</button>
          <button @click="confirmCompleteSession()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Complete Session</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Sprint Health Modal -->
  <div x-show="showSprintHealthModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" x-transition>
    <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto" @click.away="showSprintHealthModal = false">
      <div class="p-6">
        <h2 class="text-xl font-bold mb-4">Sprint Health Details</h2>
        <template x-if="selectedSprint">
          <div class="space-y-4">
            <template x-for="tag in tags" :key="tag.id">
              <div class="p-4 rounded-lg"
                   :class="{'bg-green-50': getTagHealth(selectedSprint, tag.id) === 'on_track', 'bg-yellow-50': getTagHealth(selectedSprint, tag.id) === 'at_risk', 'bg-red-50': getTagHealth(selectedSprint, tag.id) === 'off_track'}">
                <div class="flex items-center justify-between mb-2">
                  <div class="flex items-center gap-2">
                    <span x-text="tag.icon"></span>
                    <span class="font-medium" x-text="tag.name"></span>
                  </div>
                  <span class="px-2 py-0.5 rounded text-sm font-medium"
                        :class="{'bg-green-200 text-green-800': getTagHealth(selectedSprint, tag.id) === 'on_track', 'bg-yellow-200 text-yellow-800': getTagHealth(selectedSprint, tag.id) === 'at_risk', 'bg-red-200 text-red-800': getTagHealth(selectedSprint, tag.id) === 'off_track'}"
                        x-text="getTagHealth(selectedSprint, tag.id).replace('_', ' ')"></span>
                </div>
                <div class="grid grid-cols-2 gap-2 text-sm">
                  <div><span class="text-gray-500">Assigned:</span> <span class="font-medium" x-text="getSprintPointsForTag(selectedSprint, tag.id) + ' pts'"></span></div>
                  <div><span class="text-gray-500">Capacity:</span> <span class="font-medium" x-text="getCapacityForTag(selectedSprint, tag.id) + ' pts'"></span></div>
                  <div><span class="text-gray-500">Burn rate:</span> <span class="font-medium" x-text="getBurnRateNeeded(selectedSprint, tag.id).toFixed(1) + ' pts/day'"></span></div>
                  <div><span class="text-gray-500">Sustainable:</span> <span class="font-medium" x-text="(getCapacityForTag(selectedSprint, tag.id) / 7).toFixed(1) + ' pts/day'"></span></div>
                </div>
              </div>
            </template>
          </div>
        </template>
        <div class="flex justify-end mt-6">
          <button @click="showSprintHealthModal = false" class="px-4 py-2 border rounded-lg hover:bg-gray-50">Close</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Capacity Edit Modal -->
  <div x-show="showCapacityEditModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" x-transition>
    <div class="bg-white rounded-lg shadow-xl w-full max-w-sm mx-4" @click.away="showCapacityEditModal = false">
      <div class="p-6">
        <h2 class="text-xl font-bold mb-4">Edit Capacity</h2>
        <template x-if="capacityEditTag">
          <div>
            <div class="flex items-center gap-2 mb-4" :style="{ color: capacityEditTag.color }">
              <span x-text="capacityEditTag.icon" class="text-2xl"></span>
              <span class="font-medium" x-text="capacityEditTag.name"></span>
            </div>
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-1">Capacity for this sprint</label>
              <input type="number" x-model.number="capacityEditValue" min="1" class="w-full border rounded-lg px-3 py-2">
              <p class="text-xs text-gray-500 mt-1">Default: <span x-text="capacityEditTag.defaultCapacity"></span> points</p>
            </div>
            <div class="flex justify-end gap-3">
              <button @click="showCapacityEditModal = false" class="px-4 py-2 border rounded-lg hover:bg-gray-50">Cancel</button>
              <button @click="saveCapacityOverride()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Save</button>
            </div>
          </div>
        </template>
      </div>
    </div>
  </div>
  
  <!-- Tags Management Modal -->
  <div x-show="showTagsModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" x-transition>
    <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto" @click.away="showTagsModal = false">
      <div class="p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold">Manage Tags</h2>
          <button @click="showTagsModal = false" class="p-2 hover:bg-gray-100 rounded-lg">‚úï</button>
        </div>
        <div class="space-y-3 mb-6">
          <template x-for="tag in tags" :key="tag.id">
            <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
              <input type="text" x-model="tag.icon" @change="updateTag(tag)" class="w-10 text-center text-xl bg-transparent">
              <div class="flex-1">
                <input type="text" x-model="tag.name" @change="updateTag(tag)" class="font-medium bg-transparent border-b border-transparent hover:border-gray-300 focus:border-indigo-500 outline-none w-full" :style="{ color: tag.color }">
                <div class="flex items-center gap-2 mt-1">
                  <input type="color" x-model="tag.color" @change="updateTag(tag)" class="w-6 h-6 rounded cursor-pointer">
                  <span class="text-xs text-gray-500">Cap:</span>
                  <input type="number" x-model.number="tag.defaultCapacity" @change="updateTag(tag)" class="w-16 border rounded px-2 py-1 text-sm" min="1">
                </div>
              </div>
              <button @click="deleteTag(tag)" :disabled="tag.id === 'untagged'" class="p-2 text-red-500 hover:bg-red-50 rounded-lg disabled:opacity-30">üóëÔ∏è</button>
            </div>
          </template>
        </div>
        <div class="border-t pt-4">
          <h3 class="font-medium mb-3">Add New Tag</h3>
          <div class="flex items-center gap-2">
            <input type="text" x-model="newTagIcon" class="w-12 border rounded-lg px-2 py-2 text-center" placeholder="üìå">
            <input type="text" x-model="newTagName" class="flex-1 border rounded-lg px-3 py-2" placeholder="Tag name">
            <input type="color" x-model="newTagColor" class="w-10 h-10 rounded cursor-pointer">
            <input type="number" x-model.number="newTagCapacity" class="w-16 border rounded-lg px-2 py-2" placeholder="Cap" min="1">
            <button @click="addTag()" :disabled="!newTagName.trim()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50">Add</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Routines Management Modal -->
  <div x-show="showRoutinesModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" x-transition>
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto" @click.away="showRoutinesModal = false">
      <div class="p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold">Manage Routines</h2>
          <button @click="showRoutinesModal = false" class="p-2 hover:bg-gray-100 rounded-lg">‚úï</button>
        </div>
        <p class="text-sm text-gray-600 mb-4">Routines auto-filter tasks based on time. Higher priority wins when multiple match.</p>
        <div class="space-y-3 mb-6">
          <template x-for="routine in routines" :key="routine.id">
            <div class="p-4 bg-gray-50 rounded-lg">
              <div class="flex items-start justify-between gap-4">
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-2">
                    <input type="text" x-model="routine.icon" @change="updateRoutine(routine)" class="w-8 text-center bg-transparent">
                    <input type="text" x-model="routine.name" @change="updateRoutine(routine)" class="font-medium bg-transparent border-b border-transparent hover:border-gray-300" :style="{ color: routine.color }">
                    <span class="text-xs text-gray-500">Priority:</span>
                    <input type="number" x-model.number="routine.priority" @change="updateRoutine(routine)" class="w-12 border rounded px-2 py-0.5 text-sm" min="1" max="10">
                  </div>
                  <div class="grid grid-cols-2 gap-2 text-sm">
                    <div>
                      <label class="text-xs text-gray-500">Task Filter</label>
                      <input type="text" x-model="routine.taskFilterExpression" @change="updateRoutine(routine)" class="w-full border rounded px-2 py-1 text-sm" placeholder="hasTag('work')">
                    </div>
                    <div>
                      <label class="text-xs text-gray-500">Activation</label>
                      <input type="text" x-model="routine.activationExpression" @change="updateRoutine(routine)" class="w-full border rounded px-2 py-1 text-sm" placeholder="isWeekday">
                    </div>
                  </div>
                </div>
                <div class="flex items-center gap-1">
                  <input type="color" x-model="routine.color" @change="updateRoutine(routine)" class="w-8 h-8 rounded cursor-pointer">
                  <button @click="deleteRoutine(routine)" class="p-2 text-red-500 hover:bg-red-50 rounded-lg">üóëÔ∏è</button>
                </div>
              </div>
            </div>
          </template>
          <template x-if="routines.length === 0">
            <p class="text-center text-gray-500 py-4">No routines yet</p>
          </template>
        </div>
        <div class="border-t pt-4">
          <h3 class="font-medium mb-3">Add New Routine</h3>
          <div class="grid grid-cols-2 gap-3 mb-3">
            <div class="flex items-center gap-2">
              <input type="text" x-model="newRoutineIcon" class="w-10 border rounded-lg px-2 py-2 text-center" placeholder="üè†">
              <input type="text" x-model="newRoutineName" class="flex-1 border rounded-lg px-3 py-2" placeholder="Routine name">
            </div>
            <div class="flex items-center gap-2">
              <input type="color" x-model="newRoutineColor" class="w-10 h-10 rounded cursor-pointer">
              <input type="number" x-model.number="newRoutinePriority" class="w-16 border rounded-lg px-2 py-2" placeholder="Pri" min="1" max="10">
            </div>
            <input type="text" x-model="newRoutineFilter" class="border rounded-lg px-3 py-2" placeholder="Task filter (e.g., hasTag('work'))">
            <input type="text" x-model="newRoutineActivation" class="border rounded-lg px-3 py-2" placeholder="Activation (e.g., isWeekday)">
          </div>
          <div class="flex justify-end">
            <button @click="addRoutine()" :disabled="!newRoutineName.trim()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50">Add Routine</button>
          </div>
          <div class="mt-4 p-3 bg-blue-50 rounded-lg text-sm">
            <p class="font-medium text-blue-800 mb-1">Expression Examples:</p>
            <div class="grid grid-cols-2 gap-2 text-blue-700 text-xs font-mono">
              <div>hasTag("Work")</div>
              <div>isWeekday and hour >= 9</div>
              <div>age > 7</div>
              <div>dayOfWeek == "mon"</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Settings Modal -->
  <div x-show="showSettingsModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" x-transition>
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4" @click.away="showSettingsModal = false">
      <div class="p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold">Settings</h2>
          <button @click="showSettingsModal = false" class="p-2 hover:bg-gray-100 rounded-lg">‚úï</button>
        </div>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Default Session Duration</label>
            <select x-model.number="settings.defaultSessionDuration" class="w-full border rounded-lg px-3 py-2">
              <option value="15">15 minutes</option>
              <option value="25">25 minutes (Pomodoro)</option>
              <option value="45">45 minutes</option>
              <option value="60">60 minutes</option>
            </select>
          </div>
          <div class="pt-4 border-t">
            <h3 class="font-medium text-red-600 mb-2">Danger Zone</h3>
            <button @click="resetAllData()" class="w-full px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200">üóëÔ∏è Reset All Data</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    function checkMate() {
      return {
        // === CONSTANTS ===
        FIBONACCI_POINTS: [1, 2, 3, 5, 8, 13, 21],
        DAYS: ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'],
        
        // === STATE (persisted) ===
        tasks: Alpine.$persist([]).as('checkmate_tasks'),
        tags: Alpine.$persist([]).as('checkmate_tags'),
        sprints: Alpine.$persist([]).as('checkmate_sprints'),
        routines: Alpine.$persist([]).as('checkmate_routines'),
        settings: Alpine.$persist({ defaultSessionDuration: 25 }).as('checkmate_settings'),
        
        // === UI STATE ===
        currentView: 'sprint',
        selectedSprintIndex: 0,
        selectedTagFilters: [],
        manualRoutineId: '',
        today: new Date(),
        
        // === MODAL STATE ===
        showCreateTaskModal: false,
        showCreateRecurringModal: false,
        showTaskDetailModal: false,
        showSkipForDayModal: false,
        showCompleteSessionModal: false,
        showSprintHealthModal: false,
        showCapacityEditModal: false,
        showTagsModal: false,
        showRoutinesModal: false,
        showSettingsModal: false,
        
        // === FORM STATE ===
        newTask: { title: '', description: '', tagPoints: {} },
        newRecurring: { title: '', description: '', tagPoints: {}, recurrencePreset: 'FREQ=DAILY', customRRule: '' },
        selectedTask: null,
        newCommentContent: '',
        skipJustification: '',
        taskToSkip: null,
        sessionFocusLevel: 'neutral',
        sessionNote: '',
        markTaskComplete: false,
        capacityEditSprint: null,
        capacityEditTag: null,
        capacityEditValue: 0,
        newTagName: '',
        newTagIcon: 'üìå',
        newTagColor: '#6366f1',
        newTagCapacity: 20,
        newRoutineName: '',
        newRoutineIcon: 'üè†',
        newRoutineColor: '#6366f1',
        newRoutinePriority: 5,
        newRoutineFilter: '',
        newRoutineActivation: '',
        
        // === SESSION TRACKING ===
        activeSession: null,
        sessionElapsed: 0,
        sessionInterval: null,
        
        // === COMPUTED PROPERTIES ===
        get selectedSprint() {
          return this.sprints[this.selectedSprintIndex];
        },
        
        get backlogTasks() {
          return this.tasks.filter(t => t.location.type === 'backlog' && t.status === 'active' && !t.recurrence);
        },
        
        get filteredBacklogTasks() {
          let tasks = this.backlogTasks;
          if (this.selectedTagFilters.length > 0) {
            tasks = tasks.filter(t => Object.keys(t.tagPoints).some(tagId => this.selectedTagFilters.includes(tagId)));
          }
          if (this.activeRoutine) {
            tasks = tasks.filter(t => this.evaluateTaskFilter(t, this.activeRoutine.taskFilterExpression));
          }
          return tasks;
        },
        
        get recurringTemplates() {
          return this.tasks.filter(t => t.recurrence && t.status === 'active');
        },
        
        get completedTasks() {
          return this.tasks.filter(t => t.status === 'completed' || t.status === 'canceled');
        },
        
        get activeRoutine() {
          if (this.manualRoutineId) {
            return this.routines.find(r => r.id === this.manualRoutineId);
          }
          const matching = this.routines.filter(r => this.evaluateActivationExpression(r.activationExpression));
          if (matching.length === 0) return null;
          matching.sort((a, b) => {
            if (b.priority !== a.priority) return b.priority - a.priority;
            return a.name.localeCompare(b.name);
          });
          return matching[0];
        },
        
        // === LIFECYCLE ===
        init() {
          this.initializeDefaults();
          this.initializeSprints();
          setInterval(() => {
            this.today = new Date();
            this.checkSkipReturns();
          }, 60000);
          this.checkSkipReturns();
          console.log('Check Mate initialized');
        },
        
        initializeDefaults() {
          if (this.tags.length === 0) {
            this.tags = [
              { id: 'untagged', name: 'Untagged', icon: 'üì¶', color: '#6b7280', defaultCapacity: 10, description: '' },
              { id: this.generateId(), name: 'Work', icon: 'üíº', color: '#3b82f6', defaultCapacity: 25, description: 'Work tasks' },
              { id: this.generateId(), name: 'Personal', icon: 'üè†', color: '#22c55e', defaultCapacity: 15, description: 'Personal tasks' },
              { id: this.generateId(), name: 'Health', icon: '‚ù§Ô∏è', color: '#ef4444', defaultCapacity: 10, description: 'Health & fitness' },
              { id: this.generateId(), name: 'Learning', icon: 'üìö', color: '#8b5cf6', defaultCapacity: 10, description: 'Learning & growth' },
            ];
          }
          
          if (this.routines.length === 0) {
            this.routines = [
              { id: this.generateId(), name: 'Work Hours', icon: 'üíº', color: '#3b82f6', priority: 8, taskFilterExpression: 'hasTag("Work")', activationExpression: 'isWeekday and hour >= 9 and hour < 18' },
              { id: this.generateId(), name: 'Evening', icon: 'üåô', color: '#8b5cf6', priority: 5, taskFilterExpression: 'hasAnyTag("Personal", "Health")', activationExpression: 'hour >= 18 or hour < 9' },
              { id: this.generateId(), name: 'Weekend', icon: '‚òÄÔ∏è', color: '#f59e0b', priority: 7, taskFilterExpression: 'hasAnyTag("Personal", "Health", "Learning")', activationExpression: 'isWeekend' }
            ];
          }
        },
        
        initializeSprints() {
          const now = new Date();
          const currentSunday = this.getStartOfWeek(now);
          
          const requiredStarts = [currentSunday, this.addDays(currentSunday, 7), this.addDays(currentSunday, 14)];
          
          requiredStarts.forEach((startDate) => {
            const exists = this.sprints.find(s => new Date(s.startDate).toDateString() === startDate.toDateString());
            if (!exists) {
              this.sprints.push({
                id: this.generateId(),
                startDate: startDate.toISOString(),
                endDate: this.addDays(startDate, 6).toISOString(),
                capacityOverrides: {},
                taskIds: []
              });
            }
          });
          
          this.sprints.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
          
          const currentIndex = this.sprints.findIndex(s => new Date(s.startDate).toDateString() === currentSunday.toDateString());
          
          if (currentIndex > 0) {
            this.sprints.slice(0, currentIndex).forEach(pastSprint => {
              this.tasks.filter(t => t.location.type === 'sprint' && t.location.sprintId === pastSprint.id)
                .forEach(task => {
                  task.location = { type: 'backlog' };
                  task.sprintHistory = task.sprintHistory || [];
                  task.sprintHistory.push(pastSprint.id);
                });
            });
            this.sprints = this.sprints.slice(currentIndex, currentIndex + 3);
          }
          
          if (this.sprints.length > 3) {
            this.sprints = this.sprints.slice(0, 3);
          }
        },
        
        // === HELPER FUNCTIONS ===
        generateId() {
          return 'id_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
        },
        
        getTagById(tagId) {
          return this.tags.find(t => t.id === tagId);
        },
        
        getTaskById(taskId) {
          return this.tasks.find(t => t.id === taskId);
        },
        
        getTaskPrimaryTag(task) {
          const firstTagId = Object.keys(task.tagPoints)[0];
          return this.getTagById(firstTagId);
        },
        
        getTaskAge(task) {
          const created = new Date(task.createdAt);
          const diff = this.today - created;
          return Math.floor(diff / (1000 * 60 * 60 * 24));
        },
        
        formatDate(date) {
          if (!date) return '';
          const d = new Date(date);
          return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        },
        
        formatSessionTime(seconds) {
          const mins = Math.floor(seconds / 60);
          const secs = seconds % 60;
          return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        },
        
        getStartOfWeek(date) {
          const d = new Date(date);
          const day = d.getDay();
          d.setDate(d.getDate() - day);
          d.setHours(0, 0, 0, 0);
          return d;
        },
        
        addDays(date, days) {
          const d = new Date(date);
          d.setDate(d.getDate() + days);
          return d;
        },
        
        checkSkipReturns() {
          const now = new Date();
          this.tasks.forEach(task => {
            if (task.skipState?.type === 'for_day' && new Date(task.skipState.returnAt) <= now) {
              task.skipState.returned = true;
            }
          });
        },
        
        // === EXPRESSION EVALUATOR ===
        evaluateTaskFilter(task, expression) {
          if (!expression || expression.trim() === '' || expression === 'true') return true;
          if (expression === 'false') return false;
          
          try {
            const tagIds = Object.keys(task.tagPoints);
            const tagNames = tagIds.map(id => this.getTagById(id)?.name?.toLowerCase()).filter(Boolean);
            
            const context = {
              title: task.title,
              description: task.description || '',
              status: task.status,
              age: this.getTaskAge(task),
              sprintCount: task.sprintHistory?.length || 0,
              inBacklog: task.location.type === 'backlog',
              inSprint: task.location.type === 'sprint',
              points: Object.values(task.tagPoints).reduce((a, b) => a + b, 0)
            };
            
            const funcs = {
              hasTag: (name) => tagNames.includes(name.toLowerCase()),
              hasAnyTag: (...names) => names.some(n => tagNames.includes(n.toLowerCase())),
              hasAllTags: (...names) => names.every(n => tagNames.includes(n.toLowerCase()))
            };
            
            return this.safeEval(expression, context, funcs);
          } catch (e) {
            console.error('Task filter eval error:', e, expression);
            return true;
          }
        },
        
        evaluateActivationExpression(expression) {
          if (!expression || expression.trim() === '' || expression === 'false') return false;
          if (expression === 'true') return true;
          
          try {
            const now = this.today;
            const context = {
              hour: now.getHours(),
              minute: now.getMinutes(),
              dayOfWeek: this.DAYS[now.getDay()],
              date: now.getDate(),
              month: now.getMonth() + 1,
              year: now.getFullYear(),
              isWeekday: now.getDay() > 0 && now.getDay() < 6,
              isWeekend: now.getDay() === 0 || now.getDay() === 6,
              time: now.getHours() * 60 + now.getMinutes()
            };
            
            return this.safeEval(expression, context, {});
          } catch (e) {
            console.error('Activation eval error:', e, expression);
            return false;
          }
        },
        
        // Safe expression evaluation using Filtrex (no eval!)
        safeEval(expression, context, funcs) {
          try {
            // Normalize expression: convert 'and'/'or' to filtrex operators
            let expr = expression
              .replace(/\band\b/gi, ' and ')
              .replace(/\bor\b/gi, ' or ')
              .replace(/\bnot\b/gi, ' not ');

            // Compile expression with custom functions
            const filter = filtrex.compileExpression(expr, { extraFunctions: funcs });
            return Boolean(filter(context));
          } catch (e) {
            console.error('Filtrex error:', e, expression);
            return true; // Default to true on error
          }
        },
        
        // === TASK OPERATIONS ===
        createTask() {
          const tagPoints = {};
          Object.entries(this.newTask.tagPoints).forEach(([tagId, points]) => {
            if (points) tagPoints[tagId] = parseInt(points);
          });
          
          if (Object.keys(tagPoints).length === 0) {
            alert('Please assign points to at least one tag');
            return;
          }
          
          const task = {
            id: this.generateId(),
            title: this.newTask.title,
            description: this.newTask.description || '',
            status: 'active',
            tagPoints: tagPoints,
            location: { type: 'backlog' },
            createdAt: new Date().toISOString(),
            comments: [],
            sessions: [],
            skipState: null,
            recurrence: null,
            parentId: null,
            externalSource: null,
            sprintHistory: []
          };
          
          this.tasks.push(task);
          this.newTask = { title: '', description: '', tagPoints: {} };
          this.showCreateTaskModal = false;
        },
        
        createRecurringTask() {
          const tagPoints = {};
          Object.entries(this.newRecurring.tagPoints).forEach(([tagId, points]) => {
            if (points) tagPoints[tagId] = parseInt(points);
          });
          
          if (Object.keys(tagPoints).length === 0) {
            alert('Please assign points to at least one tag');
            return;
          }
          
          const rruleStr = this.newRecurring.recurrencePreset === 'custom' ? this.newRecurring.customRRule : this.newRecurring.recurrencePreset;
          
          const task = {
            id: this.generateId(),
            title: this.newRecurring.title,
            description: this.newRecurring.description || '',
            status: 'active',
            tagPoints: tagPoints,
            location: { type: 'backlog' },
            createdAt: new Date().toISOString(),
            comments: [],
            sessions: [],
            skipState: null,
            recurrence: rruleStr,
            parentId: null,
            externalSource: null,
            sprintHistory: []
          };
          
          this.tasks.push(task);
          this.newRecurring = { title: '', description: '', tagPoints: {}, recurrencePreset: 'FREQ=DAILY', customRRule: '' };
          this.showCreateRecurringModal = false;
        },
        
        updateTask(task) {
          const index = this.tasks.findIndex(t => t.id === task.id);
          if (index !== -1) this.tasks[index] = { ...task };
        },
        
        completeTask(task) {
          task.status = 'completed';
          task.completedAt = new Date().toISOString();
          this.updateTask(task);
        },
        
        cancelTask(task) {
          if (confirm(`Cancel task "${task.title}"?`)) {
            task.status = 'canceled';
            task.canceledAt = new Date().toISOString();
            this.updateTask(task);
          }
        },
        
        moveTaskToSprint(task, sprint) {
          task.location = { type: 'sprint', sprintId: sprint.id };
          task.skipState = null;
          this.updateTask(task);
        },
        
        moveTaskToBacklog(task) {
          if (task.location.type === 'sprint') {
            task.sprintHistory = task.sprintHistory || [];
            task.sprintHistory.push(task.location.sprintId);
          }
          task.location = { type: 'backlog' };
          task.skipState = null;
          this.updateTask(task);
        },
        
        skipTaskForNow(task) {
          task.skipState = { type: 'for_now', skippedAt: new Date().toISOString() };
          this.updateTask(task);
        },
        
        openSkipForDayModal(task) {
          this.taskToSkip = task;
          this.skipJustification = '';
          this.showSkipForDayModal = true;
        },
        
        confirmSkipForDay() {
          if (!this.skipJustification.trim()) return;
          
          const comment = {
            id: this.generateId(),
            content: this.skipJustification,
            createdAt: new Date().toISOString(),
            updatedAt: null,
            skipJustification: true
          };
          
          this.taskToSkip.comments = this.taskToSkip.comments || [];
          this.taskToSkip.comments.push(comment);
          
          const tomorrow = new Date();
          tomorrow.setDate(tomorrow.getDate() + 1);
          tomorrow.setHours(0, 0, 0, 0);
          
          this.taskToSkip.skipState = {
            type: 'for_day',
            skippedAt: new Date().toISOString(),
            returnAt: tomorrow.toISOString(),
            justificationCommentId: comment.id
          };
          
          this.updateTask(this.taskToSkip);
          this.showSkipForDayModal = false;
          this.taskToSkip = null;
        },
        
        clearSkipState(task) {
          task.skipState = null;
          this.updateTask(task);
        },
        
        openTaskDetail(task) {
          this.selectedTask = JSON.parse(JSON.stringify(task));
          this.newCommentContent = '';
          this.showTaskDetailModal = true;
        },
        
        saveTaskDetail() {
          if (!this.selectedTask) return;
          const index = this.tasks.findIndex(t => t.id === this.selectedTask.id);
          if (index !== -1) this.tasks[index] = this.selectedTask;
        },
        
        addComment(task) {
          if (!this.newCommentContent.trim()) return;
          
          const actualTask = this.tasks.find(t => t.id === task.id);
          if (!actualTask) return;
          
          actualTask.comments = actualTask.comments || [];
          actualTask.comments.push({
            id: this.generateId(),
            content: this.newCommentContent,
            createdAt: new Date().toISOString(),
            updatedAt: null,
            skipJustification: false
          });
          
          this.selectedTask = JSON.parse(JSON.stringify(actualTask));
          this.newCommentContent = '';
        },
        
        deleteComment(task, comment) {
          const actualTask = this.tasks.find(t => t.id === task.id);
          if (!actualTask) return;
          
          actualTask.comments = actualTask.comments.filter(c => c.id !== comment.id);
          this.selectedTask = JSON.parse(JSON.stringify(actualTask));
        },
        
        spawnRecurringInstance(template) {
          const instance = {
            id: this.generateId(),
            title: template.title,
            description: template.description,
            status: 'active',
            tagPoints: { ...template.tagPoints },
            location: { type: 'backlog' },
            createdAt: new Date().toISOString(),
            comments: [],
            sessions: [],
            skipState: null,
            recurrence: null,
            parentId: template.id,
            externalSource: null,
            sprintHistory: []
          };
          
          this.tasks.push(instance);
          return instance;
        },
        
        getNextOccurrence(template) {
          if (!template.recurrence) return null;
          try {
            const rule = rrule.RRule.fromString('DTSTART:' + new Date().toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z\nRRULE:' + template.recurrence);
            return rule.after(new Date());
          } catch (e) {
            console.error('RRule error:', e);
            return new Date();
          }
        },
        
        describeRRule(rruleStr) {
          if (!rruleStr) return '';
          const descriptions = {
            'FREQ=DAILY': 'Every day',
            'FREQ=WEEKLY': 'Every week',
            'FREQ=WEEKLY;BYDAY=MO,TU,WE,TH,FR': 'Weekdays',
            'FREQ=WEEKLY;BYDAY=MO,WE,FR': 'Mon, Wed, Fri',
            'FREQ=WEEKLY;BYDAY=TU,TH': 'Tue, Thu',
            'FREQ=MONTHLY': 'Every month'
          };
          return descriptions[rruleStr] || rruleStr;
        },
        
        // === SPRINT OPERATIONS ===
        getSprintTasks(sprint) {
          if (!sprint) return [];
          
          let tasks = this.tasks.filter(t => t.location.type === 'sprint' && t.location.sprintId === sprint.id && t.status === 'active');
          
          if (this.selectedTagFilters.length > 0) {
            tasks = tasks.filter(t => Object.keys(t.tagPoints).some(tagId => this.selectedTagFilters.includes(tagId)));
          }
          
          if (this.activeRoutine) {
            tasks = tasks.filter(t => this.evaluateTaskFilter(t, this.activeRoutine.taskFilterExpression));
          }
          
          return tasks.sort((a, b) => {
            // Returned tasks bubble to top
            if (a.skipState?.type === 'for_day' && a.skipState?.returned) return -1;
            if (b.skipState?.type === 'for_day' && b.skipState?.returned) return 1;
            // Skipped-for-day tasks go to bottom
            if (a.skipState?.type === 'for_day' && !a.skipState?.returned) return 1;
            if (b.skipState?.type === 'for_day' && !b.skipState?.returned) return -1;
            // Skipped-for-now go after normal tasks
            if (a.skipState?.type === 'for_now' && !b.skipState) return 1;
            if (b.skipState?.type === 'for_now' && !a.skipState) return -1;
            // Otherwise sort by order
            return (a.order || 0) - (b.order || 0);
          });
        },

        handleTaskReorder(itemId, newPosition) {
          const sprintTasks = this.getSprintTasks(this.selectedSprint);
          const taskIds = sprintTasks.map(t => t.id);

          // Remove from old position and insert at new
          const oldIndex = taskIds.indexOf(itemId);
          if (oldIndex !== -1) {
            taskIds.splice(oldIndex, 1);
          }
          taskIds.splice(newPosition, 0, itemId);

          // Update order values
          taskIds.forEach((id, index) => {
            const task = this.tasks.find(t => t.id === id);
            if (task) task.order = index;
          });
        },

        getSprintLabel(index) {
          if (index === 0) return 'üìÖ Current Sprint';
          if (index === 1) return '‚û°Ô∏è Next Sprint';
          if (index === 2) return '‚è≠Ô∏è Sprint +2';
          return `Sprint ${index}`;
        },
        
        getDaysRemaining(sprint) {
          const end = new Date(sprint.endDate);
          const diff = Math.ceil((end - this.today) / (1000 * 60 * 60 * 24));
          return Math.max(0, diff + 1);
        },
        
        getSprintPointsForTag(sprint, tagId) {
          return this.tasks
            .filter(t => t.location.type === 'sprint' && t.location.sprintId === sprint.id && t.status === 'active')
            .reduce((sum, task) => sum + (task.tagPoints[tagId] || 0), 0);
        },
        
        getCapacityForTag(sprint, tagId) {
          if (sprint.capacityOverrides && sprint.capacityOverrides[tagId]) {
            return sprint.capacityOverrides[tagId];
          }
          const tag = this.getTagById(tagId);
          return tag?.defaultCapacity || 10;
        },
        
        getSprintHealth(sprint) {
          if (!sprint) return { overall: 'on_track' };
          let worstHealth = 'on_track';
          
          this.tags.forEach(tag => {
            const health = this.getTagHealth(sprint, tag.id);
            if (health === 'off_track') worstHealth = 'off_track';
            else if (health === 'at_risk' && worstHealth !== 'off_track') worstHealth = 'at_risk';
          });
          
          return { overall: worstHealth };
        },
        
        getTagHealth(sprint, tagId) {
          const assigned = this.getSprintPointsForTag(sprint, tagId);
          const capacity = this.getCapacityForTag(sprint, tagId);
          const daysRemaining = Math.max(1, this.getDaysRemaining(sprint));
          
          if (assigned === 0) return 'on_track';
          
          const burnRateNeeded = assigned / daysRemaining;
          const sustainableRate = capacity / 7;
          
          if (burnRateNeeded > sustainableRate * 1.5) return 'off_track';
          if (burnRateNeeded > sustainableRate * 1.2) return 'at_risk';
          return 'on_track';
        },
        
        getBurnRateNeeded(sprint, tagId) {
          const assigned = this.getSprintPointsForTag(sprint, tagId);
          const daysRemaining = Math.max(1, this.getDaysRemaining(sprint));
          return assigned / daysRemaining;
        },
        
        editSprintCapacity(sprint, tag) {
          this.capacityEditSprint = sprint;
          this.capacityEditTag = tag;
          this.capacityEditValue = this.getCapacityForTag(sprint, tag.id);
          this.showCapacityEditModal = true;
        },
        
        saveCapacityOverride() {
          if (!this.capacityEditSprint.capacityOverrides) {
            this.capacityEditSprint.capacityOverrides = {};
          }
          this.capacityEditSprint.capacityOverrides[this.capacityEditTag.id] = this.capacityEditValue;
          this.showCapacityEditModal = false;
        },
        
        // === SESSION OPERATIONS ===
        startSession(task) {
          if (this.activeSession) return;
          
          const session = {
            id: this.generateId(),
            taskId: task.id,
            status: 'in_progress',
            startedAt: new Date().toISOString(),
            endedAt: null,
            focusLevel: null,
            comments: []
          };
          
          const actualTask = this.tasks.find(t => t.id === task.id);
          actualTask.sessions = actualTask.sessions || [];
          actualTask.sessions.push(session);
          
          this.activeSession = session;
          this.sessionElapsed = 0;
          
          this.sessionInterval = setInterval(() => {
            this.sessionElapsed++;
          }, 1000);
          
          this.showTaskDetailModal = false;
        },
        
        openCompleteSessionModal() {
          this.sessionFocusLevel = 'neutral';
          this.sessionNote = '';
          this.markTaskComplete = false;
          this.showCompleteSessionModal = true;
        },
        
        confirmCompleteSession() {
          if (!this.activeSession) return;
          
          const task = this.getTaskById(this.activeSession.taskId);
          const session = task.sessions.find(s => s.id === this.activeSession.id);
          
          session.status = 'completed';
          session.endedAt = new Date().toISOString();
          session.focusLevel = this.sessionFocusLevel;
          
          if (this.sessionNote.trim()) {
            session.comments = [{ id: this.generateId(), content: this.sessionNote, createdAt: new Date().toISOString() }];
          }
          
          if (this.markTaskComplete) {
            this.completeTask(task);
          }
          
          this.cleanupSession();
          this.showCompleteSessionModal = false;
        },
        
        abandonSession() {
          if (!this.activeSession) return;
          
          const task = this.getTaskById(this.activeSession.taskId);
          const session = task.sessions.find(s => s.id === this.activeSession.id);
          
          session.status = 'abandoned';
          session.endedAt = new Date().toISOString();
          
          this.cleanupSession();
        },
        
        cleanupSession() {
          clearInterval(this.sessionInterval);
          this.activeSession = null;
          this.sessionElapsed = 0;
          this.sessionFocusLevel = 'neutral';
          this.sessionNote = '';
          this.markTaskComplete = false;
        },
        
        // === TAG OPERATIONS ===
        addTag() {
          if (!this.newTagName.trim()) return;
          
          this.tags.push({
            id: this.generateId(),
            name: this.newTagName,
            icon: this.newTagIcon || 'üìå',
            color: this.newTagColor || '#6366f1',
            defaultCapacity: this.newTagCapacity || 20,
            description: ''
          });
          
          this.newTagName = '';
          this.newTagIcon = 'üìå';
          this.newTagColor = '#6366f1';
          this.newTagCapacity = 20;
        },
        
        updateTag(tag) {
          const index = this.tags.findIndex(t => t.id === tag.id);
          if (index !== -1) this.tags[index] = { ...tag };
        },
        
        deleteTag(tag) {
          if (tag.id === 'untagged') {
            alert('Cannot delete the Untagged tag');
            return;
          }
          
          const tasksWithTag = this.tasks.filter(t => t.tagPoints[tag.id]);
          if (tasksWithTag.length > 0) {
            alert(`Cannot delete tag "${tag.name}" - ${tasksWithTag.length} task(s) use it`);
            return;
          }
          
          this.tags = this.tags.filter(t => t.id !== tag.id);
        },
        
        toggleTagFilter(tagId) {
          if (tagId === null) {
            this.selectedTagFilters = [];
          } else {
            const index = this.selectedTagFilters.indexOf(tagId);
            if (index === -1) {
              this.selectedTagFilters.push(tagId);
            } else {
              this.selectedTagFilters.splice(index, 1);
            }
          }
        },
        
        // === ROUTINE OPERATIONS ===
        addRoutine() {
          if (!this.newRoutineName.trim()) return;
          
          this.routines.push({
            id: this.generateId(),
            name: this.newRoutineName,
            icon: this.newRoutineIcon || 'üîÑ',
            color: this.newRoutineColor || '#6366f1',
            priority: this.newRoutinePriority || 5,
            taskFilterExpression: this.newRoutineFilter || 'true',
            activationExpression: this.newRoutineActivation || 'false'
          });
          
          this.newRoutineName = '';
          this.newRoutineIcon = 'üè†';
          this.newRoutineColor = '#6366f1';
          this.newRoutinePriority = 5;
          this.newRoutineFilter = '';
          this.newRoutineActivation = '';
        },
        
        updateRoutine(routine) {
          const index = this.routines.findIndex(r => r.id === routine.id);
          if (index !== -1) this.routines[index] = { ...routine };
        },
        
        deleteRoutine(routine) {
          this.routines = this.routines.filter(r => r.id !== routine.id);
        },
        
        clearRoutineOverride() {
          this.manualRoutineId = '';
        },
        
        // === RESET ===
        resetAllData() {
          if (!confirm('This will delete ALL data. Are you sure?')) return;
          localStorage.removeItem('checkmate_tasks');
          localStorage.removeItem('checkmate_tags');
          localStorage.removeItem('checkmate_sprints');
          localStorage.removeItem('checkmate_routines');
          localStorage.removeItem('checkmate_settings');
          location.reload();
        }
      }
    }
  </script>
</body>
</html>
